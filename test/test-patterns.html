<!doctype html>
<meta charset="utf-8">
<title>github.com/met/subadub - test patterns</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

<!-- https://github.com/fiduswriter/Simple-DataTables -->
<link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css" integrity="sha384-8Ckacg2VU1a6F7C9WWfGL3hQ0LrYBIbZ9za/dpYLtntTtGvHxrzb+uLzOwZU/Xyt" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" type="text/javascript" integrity="sha384-+NH1Lmhq1u8XKi1XBTaE+L8OWwUMKaIgO+1cvgDH3N31BLAwidVFIFDQSzJK//l0" crossorigin="anonymous"></script>

<body class="container">
<h1 class="mt-3">Test patterns for subtitles transformations</h1>


<form class="mt-5 mb-3" class="row">
<label for="input" class="form-label">Subtitles to transform:</label>

<textarea id="input" class="form-control mt-3 mb-3" style="height:20em" lang="es">
Something is coming.
Something hungry for blood.
That... that sound?
The campaign took two weeks to plan.
[Mike] Something is coming.
[screaming]
[screaming continues]
-What is it?
-We're in deep shit.
-Will, your action!
-Told ya. [chuckling]
-[snorts]
-[all chuckling] 
-[yells] Boom!
&lt;i>Stick and stones,&lt;/i>
-[John]&lt;i>Stick&lt;/i> and &lt;i>stones,&lt;/i></textarea>

<div>
	<div>
		<label for="transformation-type">Type of transformation:</label>
		<select id="transformation-type" class="form-select mb-3" arila-label="Select type of transformation" style="width:30%">
			<option value="easy">Easy</option>
			<option selected value="easy-resursive">Easy recursive (default)</option>
		</select>
	</div>
	<input id="btn-process" type="button" class="btn btn-primary mb-3" value="Transform subtitles">
</div>
</form>


<div id="output-area" class="collapse mb-3">
	<div class="card row">
		<h4 class="card-header">Transformed subtitles:</h4>
		<div id="processed" class="card-text m-3">...</div>
	</div>
</div>


<footer class="text-center fst-italic pt-4">
	<p>Created by <a href="https://twitter.com/hassmanm">Martin Hassman</a>. Source code on <a href="https://github.com/met/subadub">GitHub</a>. Based on <a href="https://github.com/rsimmons/subadub">rsimmons/subadub</a></p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" type="text/javascript" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

<script type="text/javascript">
function initEvents() {
	document.getElementById("btn-process").onclick = function(e)  {
		let btn = document.getElementById("btn-process");
		btn.dataset.originalValue = btn.value;
		btn.value = "Transforming...";
		setTimeout(process, 10);
		return false;
	};
}
initEvents();


function process() {
	let text = document.getElementById("input").value;
	let lines = text.split("\n");
	let transformationType = document.getElementById("transformation-type").value;
	let output = '<table id="tbl-procesed" class="table"><thead><tr><th>Original</th><th>Transformed</th></tr></thead><tbody>';
	document.getElementById("processed").innerHTML = "";

	for (const line of lines) {

		let transformedLine;

		switch(transformationType) {
			case "easy":
				transformedLine = transformEasy(line);
				break;

			case "easy-resursive":
				transformedLine = transformEasyRecursive(line);
				break;

			case "experimental":
				transformedLine = transformExperimental(line);
				break;

			default:
				transformedLine = "UNKNOWN TRANSFORMATION";
		}

		// do not forget to escape HTML output, change "<" into "&lt;""
		output += "<tr><td>" + htmlEscape(line) + "</td><td>" + htmlEscape(transformedLine) + "</td></tr>";
	}

	output += "</tbody></table>";
	document.getElementById("processed").innerHTML = output;

	var dataTable1 = new simpleDatatables.DataTable("#tbl-procesed", {paging:false});

	document.getElementById("output-area").classList.remove("collapse");	
	document.getElementById("btn-process").value = document.getElementById("btn-process").dataset.originalValue;
}

function htmlEscape(s) {
	return s.replace(/&/g,"&amp;").replace(/</g,"&lt;");
}

function transformEasy(s) {
	return s.replace(/(\W\w+)/ig, " _ ");
}


// recursive transformational function
function transformEasyRecursive(s) {
	let transformed;

	if (!s) { return s; } // sometimes s is empty string

	// sometimes subtitles begins with a dash. In that case we keep the dash and transform rest of the string
	if (s.charAt(0) == "-") {
		transformed = "-" + transformEasyRecursive(s.substring(1));
	} else if (s.match(/<[^>]+>/)) { // looking for < anything in angle brackets >
	// sometimes subtitles contains html markup, usualy <b>, <i>, <u> and </b>, </i>, </u>. we keep text inside <>  without change and transform the rest
	// there can be more marks in one text, and not necesary in pairs
	
		// we need to find all <marks>, for that we use global string.replace with callback function
		transformed = s.replace(/([^<>]*)(<[^<>]+>)([^<>]*)/g,
			function(m,p1,p2,p3,o,s,g) { // m contains one whole match, p1 text before <angle bracket>, p2 text inside <angle bracket> including brackets, p3 text after <angle bracket>
				//console.log({m:m,p1:p1,p2:p2,p3:p3,o:o,s:s,g:g});
				return transformEasyRecursive(p1) + p2 + transformEasyRecursive(p3);
			}
	);

	} else if (s.match(/\[[^\]]+\]/)) { // looking for [ anything in square brackets]
	// sometimes subtitles contains text in square backets like [this], we keep the text inside brackets without change and transform the rest

		let results = s.match(/(.*)(\[[^\]]+\])(.*)/); // results[1] contains text before [backets], results[2] containts text inside [backets] including brackets, results[3] text after [backets]
		transformed = transformEasyRecursive(results[1]) + results[2] + transformEasyRecursive(results[3]);
	}
	else
	{
		// Finally we reach end, there are no more special characters, we can transform the text
		// remove every word, but not first word
		transformed = s.replace(/(\W\w+)/ig, " _ ");
	}

	return transformed;
}

</script>