<!doctype html>
<meta charset="utf-8">
<title>github.com/met/subadub - test patterns</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

<!-- https://github.com/fiduswriter/Simple-DataTables -->
<link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css" integrity="sha384-8Ckacg2VU1a6F7C9WWfGL3hQ0LrYBIbZ9za/dpYLtntTtGvHxrzb+uLzOwZU/Xyt" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" type="text/javascript" integrity="sha384-+NH1Lmhq1u8XKi1XBTaE+L8OWwUMKaIgO+1cvgDH3N31BLAwidVFIFDQSzJK//l0" crossorigin="anonymous"></script>

<body class="container">
<h1 class="mt-3">Test patterns for subtitles transformations</h1>


<form class="mt-5 mb-3" class="row">
<label for="input" class="form-label">Subtitles to transform:</label>

<textarea id="input" class="form-control mt-3 mb-3" style="height:20em" lang="es">
Something is coming.
Something hungry for blood.
That... that sound?
The campaign took two weeks to plan.
[Mike] Something is coming.
[screaming]
[screaming continues]
-What is it?
-We're in deep shit.
-Will, your action!
-Told ya. [chuckling]
-[snorts]
-[all chuckling] 
-[yells] Boom!
&lt;i>Stick and stones,&lt;/i>
-[John]&lt;i>Stick&lt;/i> and &lt;i>stones,&lt;/i>
&lt;i>♪ I don't care at all ♪&lt;/i>
and he's in here all the time.
If you see there stripes,
that means they're a non-player character.
All you gotta do is check the neck.
But in here, it's all good, right?
That's great.
Right. Well, thank you, Tilly.
You know, I'm just taking a break
from the real world.
and I can't even afford to flight
to go see her.
Well, they do look very, very real.
I'm sorry. That's terrible.
The ones without stripes.
we're the realies.
So are you blowing off steam playing hero,
Yeah, the real worls sucks.
or working something out?
My sister Jill
is Supergirl's biggest fan in real life.
[chuckles] Call me Bonnie.
A lone hacker, Richard Bates,
exploited it for his own ends.
Since Luthor Corp came aboard,
the only glitch involved a fail-safe.
And that was a fluke.
What would Alex say?
That with Lex, anything is possible.
I've got Henshaw, but I don't know where--
</textarea>

<div>
	<div>
		<label for="transformation-type">Type of transformation:</label>
		<select id="transformation-type" class="form-select mb-3" arila-label="Select type of transformation" style="width:30%">
			<option value="easy">Easy</option>
			<option selected value="easy-resursive">Easy recursive (default)</option>
		</select>
	</div>
	<input id="btn-process" type="button" class="btn btn-primary mb-3" value="Transform subtitles">
</div>
</form>


<div id="output-area" class="collapse mb-3">
	<div class="card row">
		<h4 class="card-header">Transformed subtitles:</h4>
		<div id="processed" class="card-text m-3">...</div>
	</div>
</div>


<footer class="text-center fst-italic pt-4">
	<p>Created by <a href="https://twitter.com/hassmanm">Martin Hassman</a>. Source code on <a href="https://github.com/met/subadub">GitHub</a>. Based on <a href="https://github.com/rsimmons/subadub">rsimmons/subadub</a></p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" type="text/javascript" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

<script type="text/javascript">
function initEvents() {
	document.getElementById("btn-process").onclick = function(e)  {
		let btn = document.getElementById("btn-process");
		btn.dataset.originalValue = btn.value;
		btn.value = "Transforming...";
		setTimeout(process, 10);
		return false;
	};
}
initEvents();


function process() {
	let text = document.getElementById("input").value;
	let lines = text.split("\n");
	let transformationType = document.getElementById("transformation-type").value;
	let output = '<table id="tbl-procesed" class="table"><thead><tr><th>Original</th><th>Transformed</th></tr></thead><tbody>';
	document.getElementById("processed").innerHTML = "";

	for (const line of lines) {

		let transformedLine;

		switch(transformationType) {
			case "easy":
				transformedLine = transformEasy(line);
				break;

			case "easy-resursive":
				transformedLine = vttTransformEasyRecursive(line);
				break;

			case "experimental":
				transformedLine = transformExperimental(line);
				break;

			default:
				transformedLine = "UNKNOWN TRANSFORMATION";
		}

		// do not forget to escape HTML output, change "<" into "&lt;""
		output += "<tr><td>" + htmlEscape(line) + "</td><td>" + htmlEscape(transformedLine) + "</td></tr>";
	}

	output += "</tbody></table>";
	document.getElementById("processed").innerHTML = output;

	var dataTable1 = new simpleDatatables.DataTable("#tbl-procesed", {paging:false});

	document.getElementById("output-area").classList.remove("collapse");	
	document.getElementById("btn-process").value = document.getElementById("btn-process").dataset.originalValue;
}

function htmlEscape(s) {
	return s.replace(/&/g,"&amp;").replace(/</g,"&lt;");
}

function transformEasy(s) {
	return s.replace(/(\W\w+)/ig, " _ ");
}


// recursive transformational function
function vttTransformEasyRecursive(s) {
	let transformed;

	if (!s) { return s; } // sometimes s is empty string

	// these are characters often found at subtitle beginning, we keep them unchanged and transform rest of the string
	let startingCharacters = ["-", "♪", " ", "'", ",", "."];

	if (startingCharacters.includes(s.charAt(0))) {
		transformed = s.charAt(0) + vttTransformEasyRecursive(s.substring(1));
	}
	// sometimes subtitles contains html markup, usualy <b>, <i>, <u> and </b>, </i>, </u>. we keep text inside <>  without change and transform the rest
	// there can be more marks in one text, and not necesary in pairs	
	else if (s.match(/<[^>]+>/)) { // looking for < anything in angle brackets >
	
		// we need to find all <marks>, for that we use global string.replace with callback function
		transformed = s.replace(/([^<>]*)(<[^<>]+>)([^<>]*)/g,
			function(m,p1,p2,p3,o,s,g) { // m contains one whole match, p1 text before <angle bracket>, p2 text inside <angle bracket> including brackets, p3 text after <angle bracket>
				//console.log({m:m,p1:p1,p2:p2,p3:p3,o:o,s:s,g:g});
				return vttTransformEasyRecursive(p1) + p2 + vttTransformEasyRecursive(p3);
			}
		);
	}
	// sometimes subtitles contains text in square backets like [this], we keep the text inside brackets without change and transform the rest
	else if (s.match(/\[[^\]]+\]/)) { // looking for [ anything in square brackets ]
		let results = s.match(/(.*)(\[[^\]]+\])(.*)/); // results[1] contains text before [backets], results[2] containts text inside [backets] including brackets, results[3] text after [backets]
		transformed = vttTransformEasyRecursive(results[1]) + results[2] + vttTransformEasyRecursive(results[3]);
	}
	// if the first word is stop word in english, keep the stop-words, but only if the next string is long enough (this prevents long sentences only from stop words)
	// TODO - detect language code and automatically choose here proper stopwords set
	else if (s.match(/^\w+/) && stopWordsEnglish.includes(s.match(/^\w+/)[0].toLowerCase()) ) { // select first word and check stop list
		let firstWord = s.match(/^\w+/)[0];
		//console.log("STOP WORDS", firstWord);

		let magicalConstantCharsAfterStopWord = 15;

		if (s.substring(firstWord.length).length > magicalConstantCharsAfterStopWord) {
			transformed = firstWord + vttTransformEasyRecursive(s.substring(firstWord.length));
		}
		else
		{	// the next string is not long enough, continue like no stopword was detected here
			transformed = s.replace(/(\W\w+)/ig, " _ ");
		}
	}
	else
	{
		// Finally we reach end, there are no more special characters, we can transform the text
		// remove every word, but not first word, keep other non word characters

		//console.log({s:s, r:s.replace(/(\W\w+)/ig, " _ ")});		
		transformed = s.replace(/(\W\w+)/ig, " _ ");
	}

	return transformed;
}

let stopWordsEnglish = ["'ll","'tis","'twas","'ve","10","39","a","a's","able","ableabout","about","above","abroad","abst","accordance","according","accordingly","across","act","actually","ad","added","adj","adopted","ae","af","affected","affecting","affects","after","afterwards","ag","again","against","ago","ah","ahead","ai","ain't","aint","al","all","allow","allows","almost","alone","along","alongside","already","also","although","always","am","amid","amidst","among","amongst","amoungst","amount","an","and","announce","another","any","anybody","anyhow","anymore","anyone","anything","anyway","anyways","anywhere","ao","apart","apparently","appear","appreciate","appropriate","approximately","aq","ar","are","area","areas","aren","aren't","arent","arise","around","arpa","as","aside","ask","asked","asking","asks","associated","at","au","auth","available","aw","away","awfully","az","b","ba","back","backed","backing","backs","backward","backwards","bb","bd","be","became","because","become","becomes","becoming","been","before","beforehand","began","begin","beginning","beginnings","begins","behind","being","beings","believe","below","beside","besides","best","better","between","beyond","bf","bg","bh","bi","big","bill","billion","biol","bj","bm","bn","bo","both","bottom","br","brief","briefly","bs","bt","but","buy","bv","bw","by","bz","c","c'mon","c's","ca","call","came","can","can't","cannot","cant","caption","case","cases","cause","causes","cc","cd","certain","certainly","cf","cg","ch","changes","ci","ck","cl","clear","clearly","click","cm","cmon","cn","co","co.","com","come","comes","computer","con","concerning","consequently","consider","considering","contain","containing","contains","copy","corresponding","could","could've","couldn","couldn't","couldnt","course","cr","cry","cs","cu","currently","cv","cx","cy","cz","d","dare","daren't","darent","date","de","dear","definitely","describe","described","despite","detail","did","didn","didn't","didnt","differ","different","differently","directly","dj","dk","dm","do","does","doesn","doesn't","doesnt","doing","don","don't","done","dont","doubtful","down","downed","downing","downs","downwards","due","during","dz","e","each","early","ec","ed","edu","ee","effect","eg","eh","eight","eighty","either","eleven","else","elsewhere","empty","end","ended","ending","ends","enough","entirely","er","es","especially","et","et-al","etc","even","evenly","ever","evermore","every","everybody","everyone","everything","everywhere","ex","exactly","example","except","f","face","faces","fact","facts","fairly","far","farther","felt","few","fewer","ff","fi","fifteen","fifth","fifty","fify","fill","find","finds","fire","first","five","fix","fj","fk","fm","fo","followed","following","follows","for","forever","former","formerly","forth","forty","forward","found","four","fr","free","from","front","full","fully","further","furthered","furthering","furthermore","furthers","fx","g","ga","gave","gb","gd","ge","general","generally","get","gets","getting","gf","gg","gh","gi","give","given","gives","giving","gl","gm","gmt","gn","go","goes","going","gone","good","goods","got","gotten","gov","gp","gq","gr","great","greater","greatest","greetings","group","grouped","grouping","groups","gs","gt","gu","gw","gy","h","had","hadn't","hadnt","half","happens","hardly","has","hasn","hasn't","hasnt","have","haven","haven't","havent","having","he","he'd","he'll","he's","hed","hell","hello","help","hence","her","here","here's","hereafter","hereby","herein","heres","hereupon","hers","herself","herse”","hes","hi","hid","high","higher","highest","him","himself","himse”","his","hither","hk","hm","hn","home","homepage","hopefully","how","how'd","how'll","how's","howbeit","however","hr","ht","htm","html","http","hu","hundred","i","i'd","i'll","i'm","i've","i.e.","id","ie","if","ignored","ii","il","ill","im","immediate","immediately","importance","important","in","inasmuch","inc","inc.","indeed","index","indicate","indicated","indicates","information","inner","inside","insofar","instead","int","interest","interested","interesting","interests","into","invention","inward","io","iq","ir","is","isn","isn't","isnt","it","it'd","it'll","it's","itd","itll","its","itself","itse”","ive","j","je","jm","jo","join","jp","just","k","ke","keep","keeps","kept","keys","kg","kh","ki","kind","km","kn","knew","know","known","knows","kp","kr","kw","ky","kz","l","la","large","largely","last","lately","later","latest","latter","latterly","lb","lc","least","length","less","lest","let","let's","lets","li","like","liked","likely","likewise","line","little","lk","ll","long","longer","longest","look","looking","looks","low","lower","lr","ls","lt","ltd","lu","lv","ly","m","ma","made","mainly","make","makes","making","man","many","may","maybe","mayn't","maynt","mc","md","me","mean","means","meantime","meanwhile","member","members","men","merely","mg","mh","microsoft","might","might've","mightn't","mightnt","mil","mill","million","mine","minus","miss","mk","ml","mm","mn","mo","more","moreover","most","mostly","move","mp","mq","mr","mrs","ms","msie","mt","mu","much","mug","must","must've","mustn't","mustnt","mv","mw","mx","my","myself","myse”","mz","n","na","name","namely","nay","nc","nd","ne","near","nearly","necessarily","necessary","need","needed","needing","needn't","neednt","needs","neither","net","netscape","never","neverf","neverless","nevertheless","new","newer","newest","next","nf","ng","ni","nine","ninety","nl","no","no-one","nobody","non","none","nonetheless","noone","nor","normally","nos","not","noted","nothing","notwithstanding","novel","now","nowhere","np","nr","nu","null","number","numbers","nz","o","obtain","obtained","obviously","of","off","often","oh","ok","okay","old","older","oldest","om","omitted","on","once","one","one's","ones","only","onto","open","opened","opening","opens","opposite","or","ord","order","ordered","ordering","orders","org","other","others","otherwise","ought","oughtn't","oughtnt","our","ours","ourselves","out","outside","over","overall","owing","own","p","pa","page","pages","part","parted","particular","particularly","parting","parts","past","pe","per","perhaps","pf","pg","ph","pk","pl","place","placed","places","please","plus","pm","pmid","pn","point","pointed","pointing","points","poorly","possible","possibly","potentially","pp","pr","predominantly","present","presented","presenting","presents","presumably","previously","primarily","probably","problem","problems","promptly","proud","provided","provides","pt","put","puts","pw","py","q","qa","que","quickly","quite","qv","r","ran","rather","rd","re","readily","really","reasonably","recent","recently","ref","refs","regarding","regardless","regards","related","relatively","research","reserved","respectively","resulted","resulting","results","right","ring","ro","room","rooms","round","ru","run","rw","s","sa","said","same","saw","say","saying","says","sb","sc","sd","se","sec","second","secondly","seconds","section","see","seeing","seem","seemed","seeming","seems","seen","sees","self","selves","sensible","sent","serious","seriously","seven","seventy","several","sg","sh","shall","shan't","shant","she","she'd","she'll","she's","shed","shell","shes","should","should've","shouldn","shouldn't","shouldnt","show","showed","showing","shown","showns","shows","si","side","sides","significant","significantly","similar","similarly","since","sincere","site","six","sixty","sj","sk","sl","slightly","sm","small","smaller","smallest","sn","so","some","somebody","someday","somehow","someone","somethan","something","sometime","sometimes","somewhat","somewhere","soon","sorry","specifically","specified","specify","specifying","sr","st","state","states","still","stop","strongly","su","sub","substantially","successfully","such","sufficiently","suggest","sup","sure","sv","sy","system","sz","t","t's","take","taken","taking","tc","td","tell","ten","tends","test","text","tf","tg","th","than","thank","thanks","thanx","that","that'll","that's","that've","thatll","thats","thatve","the","their","theirs","them","themselves","then","thence","there","there'd","there'll","there're","there's","there've","thereafter","thereby","thered","therefore","therein","therell","thereof","therere","theres","thereto","thereupon","thereve","these","they","they'd","they'll","they're","they've","theyd","theyll","theyre","theyve","thick","thin","thing","things","think","thinks","third","thirty","this","thorough","thoroughly","those","thou","though","thoughh","thought","thoughts","thousand","three","throug","through","throughout","thru","thus","til","till","tip","tis","tj","tk","tm","tn","to","today","together","too","took","top","toward","towards","tp","tr","tried","tries","trillion","truly","try","trying","ts","tt","turn","turned","turning","turns","tv","tw","twas","twelve","twenty","twice","two","tz","u","ua","ug","uk","um","un","under","underneath","undoing","unfortunately","unless","unlike","unlikely","until","unto","up","upon","ups","upwards","us","use","used","useful","usefully","usefulness","uses","using","usually","uucp","uy","uz","v","va","value","various","vc","ve","versus","very","vg","vi","via","viz","vn","vol","vols","vs","vu","w","want","wanted","wanting","wants","was","wasn","wasn't","wasnt","way","ways","we","we'd","we'll","we're","we've","web","webpage","website","wed","welcome","well","wells","went","were","weren","weren't","werent","weve","wf","what","what'd","what'll","what's","what've","whatever","whatll","whats","whatve","when","when'd","when'll","when's","whence","whenever","where","where'd","where'll","where's","whereafter","whereas","whereby","wherein","wheres","whereupon","wherever","whether","which","whichever","while","whilst","whim","whither","who","who'd","who'll","who's","whod","whoever","whole","wholl","whom","whomever","whos","whose","why","why'd","why'll","why's","widely","width","will","willing","wish","with","within","without","won","won't","wonder","wont","words","work","worked","working","works","world","would","would've","wouldn","wouldn't","wouldnt","ws","www","x","y","ye","year","years","yes","yet","you","you'd","you'll","you're","you've","youd","youll","young","younger","youngest","your","youre","yours","yourself","yourselves","youve","yt","yu","z","za","zero","zm","zr"];

</script>